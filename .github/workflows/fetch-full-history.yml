name: Fetch Full History (Players + Goalies)

on:
  workflow_dispatch: # nur manuell startbar

jobs:
  fetch_full_history:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¥ Install dependencies
        run: npm install

      - name: ğŸ§© Validate mappings.json
        run: |
          if [ ! -s data/mappings.json ]; then
            echo "âŒ mappings.json ist leer oder fehlt"
            exit 1
          fi
          if [ "$(jq length data/mappings.json)" -eq 0 ]; then
            echo "âŒ mappings.json enthÃ¤lt keine Teams"
            exit 1
          fi
          echo "âœ… mappings.json hat Inhalte"

      - name: ğŸ’ Fetch all PLAYER data (alle Saisons)
        run: |
          echo "ğŸ’ Starte Abruf aller Spielerstatistiken..."
          node scripts/fetch_players_detail.js
          echo "âœ… Spielerstatistiken abgeschlossen."

      - name: ğŸ¥… Fetch all GOALIE data (alle Saisons)
        run: |
          echo "ğŸ¥… Starte Abruf aller TorhÃ¼terstatistiken..."
          node scripts/fetch_goalies_detail.js
          echo "âœ… TorhÃ¼terstatistiken abgeschlossen."

      - name: ğŸ’¾ Commit and Push updated JSON data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ§® PrÃ¼fe auf Ã„nderungen..."
          git add data/
          git diff --cached --quiet && echo "â„¹ï¸ Keine Ã„nderungen gefunden." && exit 0

          git commit -m "ğŸ—‚ï¸ Full Historical Data Update (Players + Goalies) [skip ci]"
          git push
          echo "âœ… Ã„nderungen erfolgreich gepusht."
