name: Nightly Player Data Fetch

on:
  schedule:
    - cron: "30 22 * * *" # l√§uft t√§glich um 23:30 Uhr Schweiz-Zeit (22:30 UTC)
  workflow_dispatch:

jobs:
  fetch_players:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Check mappings.json
        run: |
          if [ ! -s data/mappings.json ]; then
            echo "‚ùå mappings.json ist leer oder fehlt"
            exit 1
          fi
          if [ "$(jq length data/mappings.json)" -eq 0 ]; then
            echo "‚ùå mappings.json enth√§lt keine Teams"
            exit 1
          fi
          echo "‚úÖ mappings.json hat Inhalte"

      - name: Run fetch_players_detail.js (nur aktuelle Saison)
        run: |
          echo "üîÑ Bestimme aktuelle SIHF-Saison..."
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')

          # Saisonlogik: SIHF Saison l√§uft von August bis April -> ab August = n√§chstes Jahr
          if [ "$MONTH" -ge 8 ]; then
            ((YEAR++))
          fi

          echo "üìÖ Aktuelle Saison: $YEAR"

          # Nur diese Saisonzeilen tempor√§r in eine Datei extrahieren
          jq --arg y "$YEAR" 'with_entries(.value |= with_entries(select(.key | startswith($y))))' data/mappings.json > data/mappings_temp.json
          
          # Wenn keine passenden Eintr√§ge vorhanden ‚Üí abbrechen
          if [ "$(jq length data/mappings_temp.json)" -eq 0 ]; then
            echo "‚ö†Ô∏è Keine Teams f√ºr Saison $YEAR gefunden, breche ab."
            exit 0
          fi

          echo "‚úÖ Starte Datenabruf f√ºr Saison $YEAR..."
cp data/mappings.json data/mappings_backup.json
mv data/mappings_temp.json data/mappings_filtered.json
node scripts/fetch_players_detail.js --mappings data/mappings_filtered.json || true
mv data/mappings_backup.json data/mappings.json

      - name: Commit and Push updated data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git reset data/mappings.json
          git commit -m "üïö Nightly Update Player Data (Season $YEAR) [skip ci]" || echo "No changes to commit"
          git push
